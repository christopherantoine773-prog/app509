<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ａｐｐｓ⁵⁰９ | Créer un compte / Connexion</title>
<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#000,#2c2c2c);
  color:#fff;
}
header{
  background:rgba(0,0,0,0.65);
  padding:16px 20px;
  border-bottom:1px solid rgba(255,255,255,0.12);
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  gap:8px;
}
header h1{
  margin:0;
  font-size:1.8rem;
  background:linear-gradient(90deg,#fff,#aaa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
#loginBtn{
  padding:8px 16px;
  border-radius:12px;
  border:none;
  background:#00aaff;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}
#loginBtn:hover{
  background:#FFD700;
  color:#000;
  box-shadow:0 0 12px #FFD700aa;
}
.container{
  max-width:440px;
  margin:30px auto;
  background:rgba(255,255,255,0.07);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:18px;
  padding:22px;
}
.form-section{
  margin-bottom:20px;
}
.form-title{
  font-size:0.9rem;
  color:#aaa;
  margin-bottom:10px;
  padding-left:10px;
  border-left:3px solid #00aaff;
}
label{
  font-size:0.85rem;
  color:#ccc;
  display:block;
  margin-bottom:4px;
}
input, select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(0,0,0,0.45);
  color:white;
  outline:none;
  box-sizing:border-box;
}
button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:12px;
  background:#555;
  color:white;
  font-weight:600;
  cursor:pointer;
}
button:hover{
  background:#00aaff;
  color:black;
}
footer{
  text-align:center;
  margin:25px 0;
  font-size:0.85rem;
  color:#aaa;
}
#loginForm{
  display:none;
}
</style>
</head>
<body>

<header>
  <h1>Ａｐｐｓ⁵⁰９</h1>
  <button id="loginBtn">Déjà un compte ? Connexion</button>
</header>

<div class="container">

<form id="signupForm">
  <div class="form-section">
    <div class="form-title">Nom</div>
    <label>Nom complet</label>
    <input type="text" id="fullname" required placeholder="Nom et prénom">
  </div>
  <div class="form-section">
    <div class="form-title">Email</div>
    <label>Email</label>
    <input type="email" id="email" required placeholder="email@example.com">
  </div>
  <div class="form-section">
    <div class="form-title">Mot de passe</div>
    <label>Mot de passe</label>
    <input type="password" id="password" required placeholder="••••••••">
  </div>
  <div class="form-section">
    <div class="form-title">Confirmer le mot de passe</div>
    <label>Confirmer le mot de passe</label>
    <input type="password" id="confirmPassword" required placeholder="••••••••">
  </div>
  <div class="form-section">
    <div class="form-title">Rôle</div>
    <select id="roleSelect">
      <option value="user" selected>Utilisateur</option>
      <option value="admin">Administrateur</option>
    </select>
  </div>
  <div class="form-section" id="adminCodeSection" style="display:none;">
    <div class="form-title">Code administrateur</div>
    <label>Entrez le code secret pour devenir admin</label>
    <input type="text" id="adminCode" placeholder="Code admin">
  </div>
  <button type="submit">Créer le compte</button>
</form>

<button id="googleLoginBtn" style="margin-top:10px; background:#2aa6ff;">Se connecter avec Google</button>

<form id="loginForm">
  <div class="form-section">
    <div class="form-title">Connexion</div>
    <label>Email</label>
    <input type="email" id="loginEmail" required placeholder="email@example.com">
    <label>Mot de passe</label>
    <input type="password" id="loginPassword" required placeholder="••••••••">
    <button type="submit">Se connecter</button>
  </div>
</form>

</div>

<footer>© 2025 — Ａｐｐｓ⁵⁰９</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAm1-53K6VuK7wdwu67pUjLU3t7S_-bwJo",
  authDomain: "app509-d7bc6.firebaseapp.com",
  projectId: "app509-d7bc6",
  storageBucket: "app509-d7bc6.firebasestorage.app",
  messagingSenderId: "1139351082",
  appId: "1:1139351082:web:18461a1249b189ef7eed53"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const signupForm = document.getElementById("signupForm");
const loginForm = document.getElementById("loginForm");
const roleSelect = document.getElementById("roleSelect");
const adminCodeSection = document.getElementById("adminCodeSection");
const googleBtn = document.getElementById("googleLoginBtn");

loginBtn.addEventListener("click",()=>{
  signupForm.style.display = "none";
  loginForm.style.display = "block";
});

roleSelect.addEventListener("change",()=>{
  adminCodeSection.style.display = roleSelect.value === "admin" ? "block" : "none";
});

// Création de compte
signupForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const fullname = document.getElementById("fullname").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirmPassword").value;
  let role = roleSelect.value;

  if(password !== confirmPassword){
    alert("⚠️ Les mots de passe ne correspondent pas !");
    return;
  }

  if(role === "admin"){
    const adminCode = document.getElementById("adminCode").value.trim();
    if(adminCode !== "098326623890"){
      alert("⚠️ Code admin incorrect ! Le compte sera créé comme utilisateur.");
      role = "user";
    }
  }

  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    const user = userCredential.user;

    await setDoc(doc(db,"users",user.uid),{
      fullname,
      email,
      role,
      createdAt: serverTimestamp()
    });

    sessionStorage.setItem("dpstore_user", JSON.stringify({ uid: user.uid, email, role, fullname }));
    alert("✅ Compte créé avec succès !");
    location.href = "profil.html";
  } catch(err){
    alert("⚠️ Erreur : " + err.message);
  }
});

// Connexion
loginForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const loginEmail = document.getElementById("loginEmail").value.trim();
  const loginPassword = document.getElementById("loginPassword").value;

  try{
    const userCredential = await signInWithEmailAndPassword(auth,loginEmail,loginPassword);
    const user = userCredential.user;
    const userSnap = await getDoc(doc(db,"users",user.uid));
    if(userSnap.exists()){
      const data = userSnap.data();
      sessionStorage.setItem("dpstore_user", JSON.stringify({ uid: user.uid, email: data.email, role: data.role, fullname: data.fullname }));
      alert("✅ Connexion réussie !");
      location.href = "profil.html";
    }
  } catch(err){
    alert("⚠️ Email ou mot de passe incorrect !");
  }
});

// Connexion Google
googleBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  try{
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    const userRef = doc(db,"users",user.uid);
    const userSnap = await getDoc(userRef);
    if(!userSnap.exists()){
      await setDoc(userRef,{
        fullname: user.displayName,
        email: user.email,
        role: "user",
        createdAt: serverTimestamp()
      });
    }

    sessionStorage.setItem("dpstore_user", JSON.stringify({ uid: user.uid, email: user.email, role: "user", fullname: user.displayName }));
    location.href = "profil.html";
  } catch(err){
    alert("⚠️ Erreur Google Auth : " + err.message);
  }
};
</script>
</body>
</html>
